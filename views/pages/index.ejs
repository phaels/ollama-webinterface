<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head'); %>
</head>
<body class="container">
    <header>
        <%- include('../partials/header'); %>
    </header>

    <main>
        <script>
            $(document).ready(function() {
                // Initialize model display
                updateModelDisplay();

                // Model selection change handler
                $('#model').on('change', function() {
                    const selectedModel = $(this).val();
                    updateModelDisplay(selectedModel);
                });

                // Auto-resize textarea
                $('textarea').on('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });

                // Submit form with Ctrl+Enter
                $('#prompt').on('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        $(this).closest('form').submit();
                    }
                });

                // Character counter
                $('#prompt').on('input', function() {
                    const length = $(this).val().length;
                    $('#char-count').text(length + '/5000 characters');
                    if (length > 4500) {
                        $('#char-count').addClass('text-danger');
                    } else {
                        $('#char-count').removeClass('text-danger');
                    }
                });

                // Auto-refresh while processing
                <% if (isProcessing) { %>
                let refreshCount = 0;
                const maxRefreshAttempts = 120;

                function checkStatus() {
                    refreshCount++;
                    if (refreshCount >= maxRefreshAttempts) {
                        console.log('Max refresh attempts reached');
                        showError('Timeout: Processing is taking too long.');
                        return;
                    }

                    $.get('/api/status', function(data) {
                        if (!data.isProcessing) {
                            location.reload();
                        } else {
                            updateProcessingStatus(refreshCount, maxRefreshAttempts);
                            setTimeout(checkStatus, 2000);
                        }
                    }).fail(function() {
                        setTimeout(checkStatus, 2000);
                    });
                }

                function updateProcessingStatus(current, max) {
                    const minutes = Math.floor((current * 2) / 60);
                    const seconds = (current * 2) % 60;
                    const statusText = `Waiting for response... (${minutes}:${seconds.toString().padStart(2, '0')})`;
                    $('.alert-warning strong').text(statusText);
                }

                function showError(message) {
                    $('.alert-warning')
                        .removeClass('alert-warning')
                        .addClass('alert-danger')
                        .html('<i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Error:</strong> ' + message);
                }

                setTimeout(checkStatus, 2000);
                <% } %>

                // Focus on prompt field
                $('#prompt').focus();
            });

            function updateModelDisplay(selectedModel = null) {
                const model = selectedModel || $('#model').val();
                if (model) {
                    $('#selected-model-info').html('Current: <strong>' + model + '</strong>');
                } else {
                    $('#selected-model-info').html('No model selected');
                }
            }

            function adjustTextareaHeight(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
            }
        </script>

        <div class="row">
            <div class="col-lg-8 col-md-12">
                <!-- Chat Interface Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0 d-flex align-items-center">
                            <i class="bi bi-robot me-2"></i> Chat Interface
                            <span class="badge bg-light text-primary ms-2">Beta</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <form action="/query" method="POST" id="chat-form">
                            <!-- Model Selection -->
                            <div class="mb-4">
                                <label for="model" class="form-label fw-semibold">
                                    <i class="bi bi-cpu me-1"></i> Select AI Model:
                                </label>
                                <select class="form-select form-select-lg" id="model" name="model" required>
                                    <option value="">-- Please select model --</option>
                                    <% models.forEach(function(model) { %>
                                        <option value="<%= model %>" <%= model === currentModel ? 'selected' : '' %>>
                                            <%= model %>
                                        </option>
                                    <% }); %>
                                </select>
                                <div class="form-text d-flex justify-content-between">
                                    <span>
                                        <i class="bi bi-info-circle me-1"></i>
                                        <%= models.length %> Model(s) available
                                    </span>
                                    <span id="selected-model-info" class="text-muted">
                                        <% if (currentModel) { %>Current: <%= currentModel %><% } %>
                                    </span>
                                </div>
                            </div>

                            <!-- Prompt Input -->
                            <div class="mb-4">
                                <label for="prompt" class="form-label fw-semibold">
                                    <i class="bi bi-pencil-square me-1"></i> Your message:
                                </label>
                                <textarea
                                    class="form-control form-control-lg auto-resize"
                                    id="prompt"
                                    name="prompt"
                                    rows="4"
                                    placeholder="Ask a question or describe your concern..."
                                    required
                                    maxlength="5000"
                                ></textarea>
                                <div class="form-text d-flex justify-content-between mt-1">
                                    <span>
                                        <i class="bi bi-keyboard me-1"></i>
                                        Ctrl+Enter to send
                                    </span>
                                    <span id="char-count">0/5000 characters</span>
                                </div>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="d-grid gap-2 d-md-flex">
                                <button type="submit"
                                        class="btn btn-primary btn-lg flex-fill"
                                        <%= isProcessing ? 'disabled' : '' %>>
                                    <i class="bi bi-send-fill me-2"></i>
                                    <%= isProcessing ? 'Processing...' : 'Submit' %>
                                </button>
                                <button type="button"
                                        class="btn btn-outline-secondary btn-lg"
                                        onclick="location.reload()"
                                        title="Refresh page">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Processing Alert -->
                <% if (isProcessing) { %>
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="flex-fill">
                            <strong class="d-block">
                                <i class="bi bi-hourglass-split me-1"></i> AI generating response...
                            </strong>
                            <small class="d-block text-muted">
                                Model used: <strong><%= currentModel %></strong> â€¢
                                This may take a few seconds.
                            </small>
                        </div>
                    </div>
                </div>
                <% } %>

                <!-- Error Alert -->
                <% if (error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
                        <div class="flex-fill">
                            <h5 class="alert-heading mb-1">Error during processing</h5>
                            <p class="mb-0"><%= error %></p>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                </div>
                <% } %>

                <!-- Response Display -->
                <% if (response && !isProcessing) { %>
                <div class="card border-success shadow-sm mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-check-circle-fill me-2"></i> Last Answer
                        </h5>
                        <small class="opacity-75">
                            <i class="bi bi-clock me-1"></i>
                            <%= new Date().toLocaleTimeString('en-US') %>
                        </small>
                    </div>
                    <div class="card-body">
                        <div class="response-content"><%= response %></div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Generated with <strong><%= currentModel %></strong> â€¢
                            <%= response.length %> characters â€¢
                            <a href="#" onclick="document.getElementById('prompt').focus(); return false;" class="text-decoration-none">
                                <i class="bi bi-arrow-return-left"></i> Ask another question
                            </a>
                        </small>
                    </div>
                </div>
                <% } %>
            </div>

            <!-- Sidebar: History & System Info -->
            <div class="col-lg-4 col-md-12">
                <!-- Chat History Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i> Chat History
                        </h5>
                        <% if (history.length > 0) { %>
                        <form action="/clear-history" method="POST" class="m-0">
                            <button type="submit"
                                    class="btn btn-sm btn-outline-light"
                                    title="Delete history"
                                    onclick="return confirm('Do you really want to delete all history?')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                        <% } %>
                    </div>

                    <div class="card-body p-0">
                        <div class="history-container" style="max-height: 600px; overflow-y: auto;">
                            <% if (history.length === 0) { %>
                            <div class="text-center py-5 text-muted">
                                <i class="bi bi-chat-left-dots display-4 d-block mb-3"></i>
                                <p class="mb-0">No conversations yet</p>
                                <small>Ask your first question!</small>
                            </div>
                            <% } else { %>
                            <div class="list-group list-group-flush">
                                <% history.forEach(function(item, index) { %>
                                <div class="list-group-item history-item px-3 py-3">
                                    <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                        <span class="badge bg-primary rounded-pill"><%= item.model %></span>
                                        <small class="text-muted">
                                            <%= new Date(item.timestamp).toLocaleTimeString('en-US') %>
                                        </small>
                                    </div>
                                    <p class="mb-2 small text-muted">
                                        <strong>Question:</strong>
                                        <%= item.prompt.length > 80 ? item.prompt.substring(0, 80) + '...' : item.prompt %>
                                    </p>
                                    <details>
                                        <summary class="text-primary small" style="cursor: pointer; list-style: none;">
                                            <i class="bi bi-chevron-down me-1"></i>
                                            <span>Show answer</span>
                                            <small class="text-muted ms-1">
                                                (<%= Math.ceil(item.response.length / 100) %> sec reading time)
                                            </small>
                                        </summary>
                                        <div class="mt-2 p-2 bg-light rounded small"><%= item.response %></div>
                                    </details>
                                </div>
                                <% }); %>
                            </div>
                            <% } %>
                        </div>
                    </div>

                    <% if (history.length > 0) { %>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            <%= history.length %> of 10 entries saved
                        </small>
                    </div>
                    <% } %>
                </div>

                <!-- System Information Card -->
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i> System Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row small">
                            <div class="col-6"><strong>Models:</strong></div>
                            <div class="col-6 text-end">
                                <span class="badge bg-primary"><%= models.length %></span>
                            </div>
                            <div class="col-6"><strong>Current Model:</strong></div>
                            <div class="col-6 text-end">
                                <span class="badge bg-success"><%= currentModel || 'None' %></span>
                            </div>
                            <div class="col-6"><strong>History:</strong></div>
                            <div class="col-6 text-end">
                                <span class="badge bg-secondary"><%= history.length %></span>
                            </div>
                            <div class="col-6"><strong>Status:</strong></div>
                            <div class="col-6 text-end">
                                <span class="badge bg-success">Online</span>
                            </div>
                        </div>
                        <hr class="my-2">
                        <div class="text-center">
                            <a href="/status" class="btn btn-outline-info btn-sm">
                                <i class="bi bi-heart-pulse me-1"></i> Detailed Status
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <%- include('../partials/footer'); %>
    </footer>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
