<!DOCTYPE html>
<html lang="de">
<head>
<%- include('../partials/head'); %>
</head>
<body class="container">
    <header>
        <%- include('../partials/header'); %>
    </header>

    <main>
        <script>
            $(document).ready(function() {
                updateModelDisplay();
                $('#model').on('change', function() {
                    const selectedModel = $(this).val();
                    updateModelDisplay(selectedModel);
                });
                $('textarea').on('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
                $('#prompt').on('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        $(this).closest('form').submit();
                    }
                });
                $('#prompt').on('input', function() {
                    const length = $(this).val().length;
                    $('#char-count').text(length + '/5000 Zeichen');
                    if (length > 4500) {
                        $('#char-count').addClass('text-danger');
                    } else {
                        $('#char-count').removeClass('text-danger');
                    }
                });
                <% if (isProcessing) { %>
                let refreshCount = 0;
                const maxRefreshAttempts = 120;
                function checkStatus() {
                    refreshCount++;
                    if (refreshCount >= maxRefreshAttempts) {
                        console.log('Max refresh attempts reached');
                        showError('Timeout: Die Verarbeitung dauert zu lange.');
                        return;
                    }
                    $.get('/api/status', function(data) {
                        if (!data.isProcessing) {
                            location.reload();
                        } else {
                            updateProcessingStatus(refreshCount, maxRefreshAttempts);
                            setTimeout(checkStatus, 2000);
                        }
                    }).fail(function() {
                        setTimeout(checkStatus, 2000);
                    });
                }
                function updateProcessingStatus(current, max) {
                    const minutes = Math.floor((current * 2) / 60);
                    const seconds = (current * 2) % 60;
                    const statusText = `Warte auf Antwort... (${minutes}:${seconds.toString().padStart(2, '0')})`;
                    $('.alert-warning strong').text(statusText);
                }
                function showError(message) {
                    $('.alert-warning')
                        .removeClass('alert-warning')
                        .addClass('alert-danger')
                        .html('<i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Fehler:</strong> ' + message);
                }
                setTimeout(checkStatus, 2000);
                <% } %>
            });
            function updateModelDisplay(selectedModel = null) {
                const model = selectedModel || $('#model').val();
                if (model) {
                    $('#selected-model-info').html('Aktuell: <strong>' + model + '</strong>');
                } else {
                    $('#selected-model-info').html('Kein Model ausgewählt');
                }
            }
        </script>

        <div class="row">
            <!-- Linke Spalte - Formular -->
            <div class="col-lg-4 col-md-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0 d-flex align-items-center">
                            <i class="bi bi-robot me-2"></i> Chat Interface
                            <span class="badge bg-light text-primary ms-2"></span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <form action="/query" method="POST" id="chat-form">
                            <div class="mb-4">
                                <label for="model" class="form-label fw-semibold">
                                    <i class="bi bi-cpu me-1"></i> AI Model auswählen:
                                </label>
                                <select class="form-select form-select-lg" id="model" name="model" required>
                                    <option value="">-- Bitte Model wählen --</option>
                                    <% models.forEach(function(model) { %>
                                    <option value="<%= model %>"<%= model === currentModel ? 'selected' : '' %>><%= model %></option>
                                    <% }); %>
                                </select>
                                <div class="form-text d-flex justify-content-between">
                                    <span>
                                        <i class="bi bi-info-circle me-1"></i>
                                        <%= models.length %> Model(s) verfügbar
                                    </span>
                                    <span id="selected-model-info" class="text-muted">
                                        <% if (currentModel) { %>Aktuell: <%= currentModel %><% } %>
                                    </span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="prompt" class="form-label fw-semibold">
                                    <i class="bi bi-pencil-square me-1"></i> Deine Nachricht:
                                </label>
                                <textarea
                                    class="form-control form-control-lg auto-resize"
                                    id="prompt"
                                    name="prompt"
                                    rows="4"
                                    placeholder="Stelle eine Frage oder beschreibe dein Anliegen..."
                                    required
                                    maxlength="5000"
                                ></textarea>
                                <div class="form-text d-flex justify-content-between mt-1">
                                    <span>
                                        <i class="bi bi-keyboard me-1"></i>
                                        Strg+Enter zum Absenden
                                    </span>
                                    <span id="char-count">0/5000 Zeichen</span>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex">
                                <button type="submit"
                                        class="btn btn-primary btn-lg flex-fill"
                                        <%= isProcessing ? 'disabled' : '' %>>
                                    <i class="bi bi-send-fill me-2"></i>
                                    <%= isProcessing ? 'Verarbeite...' : 'Absenden' %>
                                </button>
                                <button type="button"
                                        class="btn btn-outline-secondary btn-lg"
                                        onclick="location.reload()"
                                        title="Seite aktualisieren">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <% if (isProcessing) { %>
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-3" role="status">
                            <span class="visually-hidden">Lädt...</span>
                        </div>
                        <div class="flex-fill">
                            <strong class="d-block">
                                <i class="bi bi-hourglass-split me-1"></i> AI generiert Antwort...
                            </strong>
                            <small class="d-block text-muted">
                                Verwendetes Model: <strong><%= currentModel %></strong> •
                                Dies kann einige Sekunden dauern.
                            </small>
                        </div>
                    </div>
                </div>
                <% } %>

                <% if (error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
                        <div class="flex-fill">
                            <h5 class="alert-heading mb-1">Fehler bei der Verarbeitung</h5>
                            <p class="mb-0"><%= error %></p>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                </div>
                <% } %>
            </div>

            <!-- Rechte Spalte - Verlauf und Systeminfo -->
            <div class="col-lg-8 col-md-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i> Chat-Verlauf
                        </h5>
                        <% if (history.length > 0) { %>
                        <form action="/clear-history" method="POST" class="m-0">
                            <button type="submit"
                                    class="btn btn-sm btn-outline-light"
                                    title="Verlauf löschen"
                                    onclick="return confirm('Möchten Sie wirklich den gesamten Verlauf löschen?')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                        <% } %>
                    </div>

                    <div class="card-body p-0">
                        <div class="history-container" style="max-height: 600px; overflow-y: auto;">
                            <% if (history.length === 0) { %>
                            <div class="text-center py-5 text-muted">
                                <i class="bi bi-chat-left-dots display-4 d-block mb-3"></i>
                                <p class="mb-0">Noch keine Konversationen</p>
                                <small>Stelle deine erste Frage!</small>
                            </div>
                            <% } else { %>
                            <div class="list-group list-group-flush">
                                <% history.forEach(function(item, index) { %>
                                <div class="list-group-item history-item px-3 py-3">
                                    <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                        <span class="badge bg-primary rounded-pill"><%= item.model %></span>
                                        <small class="text-muted"><%= new Date(item.timestamp).toLocaleTimeString('de-DE') %></small>
                                    </div>
                                    <p class="mb-2 small text-muted">
                                        <strong>Frage:</strong>
                                        <%= item.prompt.length > 80 ? item.prompt.substring(0, 80) + '...' : item.prompt %>
                                    </p>
                                    <details>
                                        <summary class="text-primary small" style="cursor: pointer; list-style: none;">
                                            <i class="bi bi-chevron-down me-1"></i>
                                            <span>Antwort anzeigen</span>
                                            <small class="text-muted ms-1">(<%= Math.ceil(item.response.length / 100) %> Sek. Lesezeit)</small>
                                        </summary>
                                        <div class="mt-2 p-2 bg-light rounded small"><%= item.response %></div>
                                    </details>
                                </div>
                                <% }); %>
                            </div>
                            <% } %>
                        </div>
                    </div>

                    <% if (history.length > 0) { %>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            <%= history.length %> von 10 Einträgen gespeichert
                        </small>
                    </div>
                    <% } %>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i> System Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row small">
                            <div class="col-6"><strong>Models:</strong></div>
                            <div class="col-6 text-end"><span class="badge bg-primary"><%= models.length %></span></div>
                            <div class="col-6"><strong>Aktuelles Model:</strong></div>
                            <div class="col-6 text-end"><span class="badge bg-success"><%= currentModel || 'Keins' %></span></div>
                            <div class="col-6"><strong>Verlauf:</strong></div>
                            <div class="col-6 text-end"><span class="badge bg-secondary"><%= history.length %></span></div>
                            <div class="col-6"><strong>Status:</strong></div>
                            <div class="col-6 text-end"><span class="badge bg-success">Online</span></div>
                        </div>
                        <hr class="my-2">
                        <div class="text-center">
                            <a href="/status" class="btn btn-outline-info btn-sm">
                                <i class="bi bi-heart-pulse me-1"></i> Detaillierter Status
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KI-Antwort in voller Bildschirmbreite -->
        <% if (response && !isProcessing) { %>
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-success shadow-sm">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-check-circle-fill me-2"></i> KI-Antwort
                        </h5>
                        <small class="opacity-75">
                            <i class="bi bi-clock me-1"></i>
                            <%= new Date().toLocaleTimeString('de-DE') %>
                        </small>
                    </div>
                    <div class="card-body">
                        <div class="response-content" style="min-height: 200px; font-size: 1.1em; line-height: 1.6;">
                            <%= response %>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Generiert mit <strong><%= currentModel %></strong> •
                            <%= response.length %> Zeichen •
                            <a href="#" onclick="document.getElementById('prompt').focus(); return false;" class="text-decoration-none">
                                <i class="bi bi-arrow-return-left"></i> Weitere Frage stellen
                            </a>
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <% } %>
    </main>

    <footer>
        <%- include('../partials/footer'); %>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $('#prompt').on('input', function() {
            const length = $(this).val().length;
            $('#char-count').text(length + '/5000 Zeichen');
            if (length > 4500) {
                $('#char-count').addClass('text-danger');
            } else {
                $('#char-count').removeClass('text-danger');
            }
        });
        $('#model').on('change', function() {
            const selected = $(this).val();
            $('#selected-model-info').text(selected ? 'Aktuell: ' + selected : 'Kein Model ausgewählt');
        });
        $(document).ready(function() {
            const selectedModel = $('#model').val();
            if (selectedModel) {
                $('#selected-model-info').text('Aktuell: ' + selectedModel);
            }
            $('#prompt').focus();
        });
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('prompt');
            if (textarea) {
                adjustTextareaHeight(textarea);
            }
        });
        function restoreLastPrompt() {
            <% if (history.length > 0) { %>
            const lastPrompt = `<%= history[0].prompt.replace(/`/g, '\\`').replace(/\n/g, '\\n') %>`;
            document.getElementById('prompt').value = lastPrompt;
            adjustTextareaHeight(document.getElementById('prompt'));
            document.getElementById('prompt').focus();
            <% } %>
        }
        function useLastResponseAsPrompt() {
            <% if (history.length > 0) { %>
            const lastResponse = `<%= history[0].response.replace(/`/g, '\\`').replace(/\n/g, '\\n') %>`;
            document.getElementById('prompt').value = "Erkläre das genauer: " + lastResponse.substring(0, 200) + "...";
            adjustTextareaHeight(document.getElementById('prompt'));
            document.getElementById('prompt').focus();
            <% } %>
        }
    </script>
</body>
</html>
